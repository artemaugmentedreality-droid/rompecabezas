<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Reto AR Puzzle - Premium</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        :root { 
            --whatsapp: #25D366; 
            --gold: #FFD700; 
            --deep-purple: #1a0b2e;
            --magenta: #d946ef;
        }
        
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #000; }
        
        /* Pantalla de Inicio */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a, #000); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; color: white; text-align: center;
        }

        #startBtn {
            padding: 20px 50px; border-radius: 50px; border: none;
            background: linear-gradient(45deg, var(--whatsapp), #128C7E);
            color: white; font-weight: bold; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 10px 20px rgba(37, 211, 102, 0.3);
        }

        /* Rejilla del Puzzle */
        #puzzle-ui {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; grid-template-columns: repeat(3, 1fr); gap: 8px;
            width: 85vw; max-width: 380px; background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px); padding: 15px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2); z-index: 1000;
        }

        .piece { aspect-ratio: 1 / 1; background-size: cover; border-radius: 8px; border: 2px solid rgba(255,255,255,0.1); transition: 0.3s; cursor: pointer; }
        .selected { border: 3px solid var(--whatsapp); transform: scale(1.05); box-shadow: 0 0 15px var(--whatsapp); z-index: 1010; }

        /* Step Registro (Post-Victoria) */
        #step-registro, .modal-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(26, 11, 46, 0.95); z-index: 2000; 
            flex-direction: column; justify-content: center; align-items: center; color: white;
        }

        .form-box { width: 85%; max-width: 320px; text-align: center; }
        input { width: 100%; margin: 10px 0; padding: 15px; border-radius: 12px; border: none; font-size: 16px; box-sizing: border-box; }
        
        .btn-action { 
            background: linear-gradient(135deg, var(--whatsapp), #128C7E); 
            color: white; border: none; padding: 16px; border-radius: 50px; 
            font-weight: 800; width: 100%; cursor: pointer; margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Modal Privacidad */
        .modal-content { background: white; color: #333; padding: 25px; border-radius: 20px; width: 80%; max-width: 350px; text-align: left; }

        .instruction { position: fixed; top: 10%; width: 100%; text-align: center; color: white; font-weight: bold; display: none; z-index: 500; text-shadow: 0 2px 8px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="font-weight: 300; letter-spacing: 3px;">RETO PUZZLE AR</h1>
        <button id="startBtn">JUGAR AHORA</button>
        <p style="opacity: 0.6; margin-top: 20px; font-size: 14px;">Escanea el objetivo para desbloquear</p>
    </div>

    <div id="instruction-text" class="instruction">INTERCAMBIA LAS PIEZAS HASTA ARMAR LA IMAGEN</div>

    <div id="puzzle-ui"></div>

    <div id="step-registro">
        <div class="form-box">
            <h2 style="color: var(--gold); margin-bottom: 5px;">¬°LO LOGRASTE!</h2>
            <p style="margin-bottom: 20px;">Ingresa tus datos para reclamar tu premio.</p>
            <input type="text" id="nombre" placeholder="Tu nombre completo">
            <input type="tel" id="whatsapp_input" placeholder="WhatsApp (10 d√≠gitos)">
            
            <div style="font-size: 12px; margin: 15px 0; display: flex; align-items: flex-start; gap: 8px;">
                <input type="checkbox" id="aviso" style="width: 18px; height: 18px;"> 
                <label for="aviso" style="text-align: left;">Acepto el <a href="javascript:void(0)" onclick="toggleModal(true)" style="color: var(--whatsapp); font-weight: bold;">aviso de privacidad</a>.</label>
            </div>
            
            <button class="btn-action" onclick="enviarWhatsApp()">RECLAMAR POR WHATSAPP</button>
        </div>
    </div>

    <div id="modal-priv" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#128C7E">Privacidad de Datos</h3>
            <p style="font-size: 14px; line-height: 1.4;">
                Sus datos ser√°n enviados directamente v√≠a WhatsApp para la entrega de su premio. No almacenamos esta informaci√≥n en bases de datos externas.
            </p>
            <button class="btn-action" onclick="toggleModal(false)">ENTENDIDO</button>
        </div>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: no; uiScanning: no;" vr-mode-ui="enabled: false">
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity id="target-anchor" mindar-image-target="targetIndex: 0"></a-entity>
    </a-scene>

    <script>
        const puzzleUI = document.querySelector('#puzzle-ui');
        const stepRegistro = document.querySelector('#step-registro');
        const sceneEl = document.querySelector('a-scene');

        const correctOrder = ['r1.webp', 'r2.webp', 'r3.webp', 'r4.webp', 'r5.webp', 'r6.webp', 'r7.webp', 'r8.webp', 'r9.webp'];
        let shuffledOrder = [...correctOrder].sort(() => Math.random() - 0.5);
        let firstSelected = null;

        // Inicializar Puzzle
        function initPuzzle() {
            puzzleUI.innerHTML = '';
            shuffledOrder.forEach((imgName) => {
                const piece = document.createElement('div');
                piece.className = 'piece';
                piece.style.backgroundImage = `url(assets/${imgName})`;
                piece.dataset.id = imgName;
                piece.onclick = () => handlePieceClick(piece);
                puzzleUI.appendChild(piece);
            });
        }

        function handlePieceClick(piece) {
            if (!firstSelected) {
                firstSelected = piece;
                piece.classList.add('selected');
            } else if (firstSelected === piece) {
                firstSelected.classList.remove('selected');
                firstSelected = null;
            } else {
                // Intercambio
                const tempBg = firstSelected.style.backgroundImage;
                const tempId = firstSelected.dataset.id;
                
                firstSelected.style.backgroundImage = piece.style.backgroundImage;
                firstSelected.dataset.id = piece.dataset.id;
                
                piece.style.backgroundImage = tempBg;
                piece.dataset.id = tempId;
                
                firstSelected.classList.remove('selected');
                firstSelected = null;
                checkWin();
            }
        }

        function checkWin() {
            const currentPieces = Array.from(document.querySelectorAll('.piece'));
            const playerOrder = currentPieces.map(p => p.dataset.id);
            if (JSON.stringify(playerOrder) === JSON.stringify(correctOrder)) {
                setTimeout(() => {
                    puzzleUI.style.display = 'none';
                    document.querySelector('#instruction-text').style.display = 'none';
                    stepRegistro.style.display = 'flex';
                }, 500);
            }
        }

        // Funciones de Formulario
        function toggleModal(show) { document.getElementById('modal-priv').style.display = show ? 'flex' : 'none'; }

        function enviarWhatsApp() {
            const nom = document.getElementById('nombre').value;
            const tel = document.getElementById('whatsapp_input').value;
            const folio = Math.floor(1000 + Math.random() * 9000);

            if(!nom || tel.length < 10) { alert("Por favor ingresa tu nombre y un WhatsApp v√°lido."); return; }
            if(!document.getElementById('aviso').checked) { alert("Debes aceptar el aviso de privacidad."); return; }

            const msg = encodeURIComponent(`*RECLAMO DE PREMIO - PUZZLE AR*\nüèÜ ¬°He completado el rompecabezas!\nüÜî Folio: #AR-${folio}\nüë§ Cliente: ${nom}\nüì± WhatsApp: ${tel}`);
            window.location.href = `https://wa.me/5215542492026?text=${msg}`;
        }

        // Control de AR
        document.querySelector('#startBtn').addEventListener('click', () => {
            document.querySelector('#overlay').style.display = 'none';
            sceneEl.systems['mindar-image-system'].start();
        });

        document.querySelector('#target-anchor').addEventListener("targetFound", () => {
            puzzleUI.style.display = 'grid';
            document.querySelector('#instruction-text').style.display = 'block';

            setTimeout(() => {
                const mindarSystem = sceneEl.systems['mindar-image-system'];
                if (mindarSystem) {
                    mindarSystem.stop(); 
                    const video = document.querySelector('video');
                    if(video) video.style.filter = "blur(15px) brightness(0.4)";
                }
            }, 1200); 
        });

        initPuzzle();
    </script>
</body>
</html>
